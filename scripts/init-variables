#!/bin/bash -e

function usage {
  echo "USAGE: $0 <aws-region> <core-os-channel> <coreos-vm-type>"
  echo "  example: $0 us-west-1 stable hvm"
}

if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
  usage
  exit 1
fi

AWS_REGION="$1"
COREOS_CHANNEL="$2"
COREOS_VM_TYPE="$3"

COREOS_AMI_ID=$(curl --silent https://coreos.com/dist/aws/aws-$COREOS_CHANNEL.json | grep -A 2 "$AWS_REGION" | grep $COREOS_VM_TYPE | cut -d"\"" -f4)
[ -z "$COREOS_AMI_ID" ] && echo "FAIL: region $1 not found or doesn't include a CoreOS $COREOS_CHANNEL, $COREOS_VM_TYPE backed AMI" && exit 1

AWS_ACCOUNT_ID=`aws iam get-user --output json \
	| awk '/arn:aws:/{print $2}' \
	| grep -Eo '[[:digit:]]{12}'`

AWS_REGION_AZS=`aws ec2 describe-availability-zones --region ${AWS_REGION} --output json \
  | jq --raw-output '.AvailabilityZones | map(.ZoneName) | .[]' \
  | xargs \
  | sed -e 's/ /,/g'`


cat <<EOF
# Generated by scripts/init-variables.sh
aws.account-id = "${AWS_ACCOUNT_ID}"
aws.azs = "${AWS_REGION_AZS}"
coreos-aws.ami = "${COREOS_AMI_ID}"
coreos-aws.channel = "${COREOS_CHANNEL}"
coreos-aws.type = "${COREOS_VM_TYPE}"
EOF
